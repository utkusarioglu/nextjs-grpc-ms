name: build-and-push

on:
  workflow_call:

jobs:
  container-build:
    uses: ./.github/workflows/container.build.wfc.yml
    secrets: inherit

  create-variables:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.create-variables.outputs.image_tag }}
    steps:
      - id: create-variables
        run: |
          repo_tag="${{ github.ref_name }}"
          image_tag="${repo_tag//\//-}"
          echo "image tag is: $image_tag"
          echo "image_tag=$image_tag" >> "$GITHUB_OUTPUT"

  test-k8s-integration:
    uses: utkusarioglu/nextjs-grpc-infra/.github/workflows/k3d-dev-local.test.wfc.yml@experiment/test/workflow-calls
    secrets: inherit
    needs:
      - container-build
      - create-variables
    with:
      frontendRef: ${{ github.ref_name }}
      infraRef: experiment/test/workflow-calls

      msImageTag: ${{ needs.create-variables.outputs.image_tag }}
      # webServerImageTag: ${{ needs.create-variables.outputs.image_tag }}
