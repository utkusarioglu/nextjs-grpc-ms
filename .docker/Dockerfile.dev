FROM node:19-slim AS builder

ARG ROOT_PASS
ARG USERNAME
ARG GROUP
ARG PROJECT_ABSPATH=/utkusarioglu-com/projects/nextjs-grpc

RUN sh -c 'echo "root:$ROOT_PASS" | chpasswd'
RUN sh -c 'echo "node:$ROOT_PASS" | chpasswd'

RUN apt update 
WORKDIR $PROJECT_ABSPATH/ms
COPY ms $PROJECT_ABSPATH/ms
COPY proto $PROJECT_ABSPATH/proto
RUN chown -R $CONTAINER_USERNAME:$CONTAINER_GROUP $PROJECT_ABSPATH
RUN yarn
RUN yarn build

FROM node:19-slim AS runner

ARG ROOT_PASS
ARG USERNAME
ARG GROUP
ARG PROJECT_ABSPATH=/utkusarioglu-com/projects/nextjs-grpc

RUN sh -c 'echo "root:$ROOT_PASS" | chpasswd'
RUN sh -c 'echo "node:$ROOT_PASS" | chpasswd'

WORKDIR $PROJECT_ABSPATH/ms
COPY --from=builder $PROJECT_ABSPATH/ms/dist dist
COPY --from=builder $PROJECT_ABSPATH/ms/scripts scripts
COPY --from=builder $PROJECT_ABSPATH/ms/package.json package.json
COPY --from=builder $PROJECT_ABSPATH/ms/yarn.lock yarn.lock
COPY --from=builder $PROJECT_ABSPATH/ms/tsconfig-paths.js tsconfig-paths.js

WORKDIR $PROJECT_ABSPATH/proto
COPY --from=builder $PROJECT_ABSPATH/proto/src src
RUN rm -rf src/defunct

WORKDIR $PROJECT_ABSPATH/ms
RUN yarn --frozen-lockfile --prod

USER $USERNAME
ENTRYPOINT scripts/start.sh
